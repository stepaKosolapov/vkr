\chapter{Файлы awk}

\hypertarget{ap_awk}{}

\begin{lstlisting}[language=awk, style=mystyle, caption=AWK скрипт для подсчёта параметра delay]
    BEGIN {
      seqno = -1;    
      count = 0;
    }{
      if($4 == "AGT" && $1 == "s" && seqno < $6) {
            seqno = $6;
      } 
      if($4 == "AGT" && $1 == "s") {
            start_time[$6] = $2;
      } else if(($7 == "tcp") && ($1 == "r")) {
          end_time[$6] = $2;
      } else if($1 == "D" && $7 == "tcp") {
            end_time[$6] = -1;
      } 
    } END {        
      for (i=0; i<=seqno; i++) {
          if(end_time[i] > 0) {
              delay[i] = end_time[i] - start_time[i];
              count++;
          } else {
              delay[i] = -1;
          }
      }
      for (i=0; i<=seqno; i++) {
          if(delay[i] > 0) {
              n_to_n_delay = n_to_n_delay + delay[i];
          }         
      }
      n_to_n_delay = n_to_n_delay/count;
      print n_to_n_delay * 1000;
    }
    \end{lstlisting}
    
    \begin{lstlisting}[language=awk, style=mystyle, caption=AWK скрипт для подсчёта параметра NRL]
    BEGIN {
      recvd = 0;
      rt_pkts = 0;
    }{
      if (( $1 == "r") && ( $7 == "cbr" || $7 =="tcp" ) && ( $4=="AGT" ))
      recvd++;
      if (($1 == "s" || $1 == "f") && $4 == "RTR" && ($7 =="AODV" || $7 
      =="message" || $7 =="DSR" || $7 =="OLSR" || $7 == "DSDV")) rt_pkts++;
    }END {
      print rt_pkts/recvd;
    }
    \end{lstlisting}
    
    \begin{lstlisting}[language=awk, style=mystyle, caption=AWK скрипт для подсчёта параметра Packets sent]
      BEGIN {
      seqno = -1;    
    }{
      if ($4 == "AGT" && $1 == "s" && seqno < $6) {
        seqno = $6;
      }
    } END {
      print seqno+1;
    } 
    \end{lstlisting}
    
    \begin{lstlisting}[language=awk, style=mystyle, caption=AWK скрипт для подсчёта параметра PDR]
    BEGIN {
      seqno = -1; 
      droppedPackets = 0;
      receivedPackets = 0;
      count = 0;
    } {
      event = $1
      time = $2
      pkt_size = $8
      level = $4
      if(level == "AGT" && event == "s" && seqno < $6) {
        seqno = $6;
      } else if((level == "AGT") && (event == "r")) {
        receivedPackets++;
      } else if (event == "D" && $7 == "tcp" && pkt_size > 512){
        droppedPackets++; 
      }
    } END { 
      print receivedPackets/(seqno+1)*100;
    }
    \end{lstlisting}
    
    \begin{lstlisting}[language=awk, style=mystyle, caption=AWK скрипт для подсчёта параметра Throughput]
    BEGIN {
      recvdSize = 0
      startTime = 400
      stopTime = 0
    } {
      event = $1
      time = $2
      node_id = $3
      pkt_size = $8
      level = $4
      if (level == "AGT" && event == "s" && pkt_size >= 512) {
        if (time < startTime) {
          startTime = time
        }
      }
      if (level == "AGT" && event == "r" && pkt_size >= 512) {
        if (time > stopTime) {
          stopTime = time
        }
        hdr_size = pkt_size % 512
        pkt_size -= hdr_size
        recvdSize += pkt_size
      }
    } END {
      print (recvdSize/(stopTime-startTime))*(8/1000)
    }
    \end{lstlisting}